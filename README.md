# Semiff: Real-to-Sim-to-Real Pipeline

ç»Ÿä¸€è®¡ç®—ç©ºé—´æ™ºèƒ½ç¯å¢ƒæ¶æ„ï¼šWarp + gsplat + ProPainter + VoMP (xArm Edition)

## ğŸ“– ç®€ä»‹

Semiff æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Real-to-Sim-to-Real æµæ°´çº¿æ¡†æ¶ï¼Œç”¨äºå°†ç°å®ä¸–ç•Œçš„æœºå™¨äººå’Œç¯å¢ƒè½¬æ¢ä¸ºç‰©ç†å¯ä»¿çœŸçš„æ•°å­—å­ªç”Ÿä½“ã€‚é‡‡ç”¨åŸºäº Sapien çš„ç»Ÿä¸€å·¥å…·é“¾ï¼Œç¡®ä¿åæ ‡ç³»ç»Ÿä¸€è‡´æ€§ï¼Œå®ç°å¯é çš„ Sim2Real å¯¹é½ã€‚

## âœ¨ ä¸»è¦ç‰¹æ€§

- **ç»Ÿä¸€å·¥å…·é“¾**: åŸºäº Sapien çš„æœºå™¨äººå¤„ç†ï¼Œæ¶ˆé™¤åæ ‡ç³»å†²çª
- **å¤šé˜¶æ®µæµæ°´çº¿**: æ•°æ®æ‘„å– â†’ å‡ ä½•æ„ŸçŸ¥ â†’ 3DGSè®­ç»ƒ â†’ åæ ‡å¯¹é½ â†’ èµ„äº§ç”Ÿæˆ
- **æ¨¡å—åŒ–è®¾è®¡**: æ¸…æ™°çš„æ¶æ„ï¼Œæ”¯æŒç‹¬ç«‹æµ‹è¯•å’Œæ‰©å±•
- **ç”Ÿäº§çº§ä»£ç **: å®Œå–„çš„é”™è¯¯å¤„ç†ã€æ—¥å¿—è®°å½•å’Œæ–‡æ¡£
- **äº¤äº’å¼å·¥å…·**: å¯è§†åŒ–å…³èŠ‚è§’åº¦é…ç½®ç”Ÿæˆ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…

```bash
# æ¿€æ´» uv ç¯å¢ƒ
source .venv/bin/activate

# åŒæ­¥ä¾èµ–
uv sync

# å®‰è£…é¡¹ç›®ä¸ºå¯ç¼–è¾‘åŒ…
pip install -e .

# å®‰è£…å¯é€‰ä¾èµ–ï¼ˆ3DGSè®­ç»ƒï¼‰
pip install nerfstudio
```

### æ•°æ®å‡†å¤‡

1. **åˆ›å»ºæ•°æ®ç›®å½•ç»“æ„**:
```bash
mkdir -p data/example_01/{robot/meshes,config}
```

2. **å‡†å¤‡æ•°æ®æ–‡ä»¶**:
   - å°†è§†é¢‘æ–‡ä»¶æ”¾åˆ° `data/example_01/video.mp4`
   - ä» `ly-xxx/rllab_xarm` ä¸‹è½½ URDF æ–‡ä»¶åˆ° `data/example_01/robot/robot.urdf`
   - å°†å¯¹åº”çš„ mesh æ–‡ä»¶æ”¾åˆ° `data/example_01/robot/meshes/`

3. **ç”Ÿæˆå…³èŠ‚é…ç½®** (äº¤äº’å¼):
```bash
python tools/make_joint_json.py \
    --urdf data/example_01/robot/robot.urdf \
    --out data/example_01/config/align_pose.json
```

åœ¨å¼¹å‡ºçš„çª—å£ä¸­ï¼Œä½¿ç”¨æ»‘å—è°ƒæ•´æœºå™¨äººå§¿æ€ï¼Œä½¿å…¶ä¸è§†é¢‘ä¸­çš„æœºå™¨äººå§¿æ€åŒ¹é…ï¼Œç„¶åå…³é—­çª—å£ä¿å­˜é…ç½®ã€‚

## ğŸ“‹ å®Œæ•´æµæ°´çº¿

### Step 1: åœºæ™¯é‡å»º

ä½¿ç”¨ MASt3R è¿›è¡Œ 3D é‡å»ºï¼Œç”Ÿæˆåœºæ™¯å‡ ä½•ã€‚

```bash
python tools/step1_reconstruct.py --video data/example_01/video.mp4
```

**è¾“å‡º**:
- `outputs/mast3r_result/scene.ply`: é‡å»ºçš„ç¨ å¯†ç‚¹äº‘
- `outputs/mast3r_result/poses.npy`: ç›¸æœºä½å§¿

### Step 2: è®­ç»ƒ 3D é«˜æ–¯æ•£å°„æ¨¡å‹

è®­ç»ƒé«˜è´¨é‡çš„ Gaussian Splatting æ¨¡å‹ï¼ˆæ¨èä½¿ç”¨ Nerfstudioï¼‰ã€‚

```bash
python tools/step2_train_splat.py \
    --method nerfstudio \
    --data_dir outputs/mast3r_result \
    --output_dir outputs/splat \
    --iterations 30000
```

**è¾“å‡º**:
- `outputs/splat/scene.ply`: è®­ç»ƒå¥½çš„ 3DGS æ¨¡å‹ï¼ˆå¸¦ SH é¢œè‰²ï¼‰

### Step 3: èµ„äº§ç”Ÿæˆä¸å¯¹é½

ä½¿ç”¨ Sapien è¿›è¡Œè‡ªåŠ¨ Sim2Real å¯¹é½ï¼Œç”Ÿæˆå¯¹é½åçš„èµ„äº§ã€‚

```bash
python tools/step3_build_assets.py \
    --urdf data/example_01/robot/robot.urdf \
    --splat outputs/splat/scene.ply \
    --qpos_json data/example_01/config/align_pose.json \
    --out_dir outputs/assets
```

**è¾“å‡º**:
- `outputs/assets/scene_aligned.ply`: å¯¹é½åçš„åœºæ™¯ï¼ˆæœºå™¨äººåæ ‡ç³»ï¼‰
- `outputs/assets/T_world.npy`: å˜æ¢çŸ©é˜µ
- `outputs/assets/asset_info.json`: èµ„äº§ä¿¡æ¯

### Step 4: è¯­ä¹‰åˆ†å‰² (å¯é€‰)

ä½¿ç”¨ SAM2 è¿›è¡Œè§†é¢‘åˆ†å‰²ï¼Œè¯†åˆ«åœºæ™¯ä¸­çš„ç‰©ä½“å’Œæœºå™¨äººã€‚

```bash
python tools/step2_segment.py --video data/example_01/video.mp4
```

**è¾“å‡º**:
- `outputs/masks_object/*.png`: ç‰©ä½“æ©ç 
- `outputs/masks_robot/*.png`: æœºå™¨äººæ©ç 

### Step 5: é›†æˆéªŒè¯

éªŒè¯æ•´ä¸ªæµæ°´çº¿è¾“å‡ºï¼Œç”Ÿæˆæœ€ç»ˆçš„å¯è§†åŒ–å’ŒæŠ¥å‘Šã€‚

```bash
python tools/step5_integrate.py
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
semiff/
â”œâ”€â”€ data/                      # åŸå§‹æ•°æ®ç›®å½•
â”‚   â””â”€â”€ example_01/            # æ ·ä¾‹æ•°æ®é›†
â”‚       â”œâ”€â”€ video.mp4          # æºè§†é¢‘
â”‚       â”œâ”€â”€ robot/              # æœºå™¨äººæè¿°æ–‡ä»¶
â”‚       â”‚   â”œâ”€â”€ robot.urdf     # URDF æ–‡ä»¶
â”‚       â”‚   â””â”€â”€ meshes/        # æ¨¡å‹æ–‡ä»¶
â”‚       â””â”€â”€ config/
â”‚           â””â”€â”€ align_pose.json # å…³èŠ‚é…ç½®ï¼ˆç”±å·¥å…·ç”Ÿæˆï¼‰
â”œâ”€â”€ outputs/                   # è‡ªåŠ¨ç”Ÿæˆçš„ä¸­é—´ç»“æœ
â”‚   â”œâ”€â”€ mast3r_result/         # Step 1 è¾“å‡º
â”‚   â”œâ”€â”€ splat/                 # Step 2 è¾“å‡º
â”‚   â””â”€â”€ assets/                # Step 3 è¾“å‡º
â”œâ”€â”€ tools/                     # æµæ°´çº¿è„šæœ¬
â”‚   â”œâ”€â”€ step1_reconstruct.py   # åœºæ™¯é‡å»º
â”‚   â”œâ”€â”€ step2_train_splat.py   # 3DGS è®­ç»ƒ
â”‚   â”œâ”€â”€ step3_build_assets.py  # èµ„äº§ç”Ÿæˆä¸å¯¹é½
â”‚   â”œâ”€â”€ make_joint_json.py     # äº¤äº’å¼å…³èŠ‚é…ç½®å·¥å…·
â”‚   â””â”€â”€ ...
â”œâ”€â”€ src/semiff/                # æ ¸å¿ƒä»£ç 
â”‚   â”œâ”€â”€ utils/                 # å·¥å…·æ¨¡å—ï¼ˆåŸºäº real2sim-evalï¼‰
â”‚   â”‚   â”œâ”€â”€ robot/             # æœºå™¨äººå¤„ç†ï¼ˆSapienï¼‰
â”‚   â”‚   â””â”€â”€ gs/                # é«˜æ–¯æ•£å°„å¤„ç†
â”‚   â”œâ”€â”€ perception/            # è§†è§‰æ„ŸçŸ¥ (MASt3R, SAM2)
â”‚   â”œâ”€â”€ calibration/           # åæ ‡å¯¹é½ï¼ˆå·²åºŸå¼ƒï¼Œä½¿ç”¨ utilsï¼‰
â”‚   â”œâ”€â”€ geometry/               # å‡ ä½•å¤„ç†
â”‚   â””â”€â”€ simulation/            # ä»¿çœŸç¯å¢ƒ
â””â”€â”€ README.md                  # æœ¬æ–‡æ¡£
```

## ğŸ”§ æ ¸å¿ƒå·¥å…·

### make_joint_json.py

äº¤äº’å¼å…³èŠ‚è§’åº¦é…ç½®ç”Ÿæˆå·¥å…·ã€‚ä½¿ç”¨ Sapien Viewer å¯è§†åŒ–è°ƒæ•´æœºå™¨äººå§¿æ€ï¼Œè‡ªåŠ¨ä¿å­˜ä¸º JSON é…ç½®æ–‡ä»¶ã€‚

**ç”¨æ³•**:
```bash
python tools/make_joint_json.py \
    --urdf <URDFè·¯å¾„> \
    --out <è¾“å‡ºJSONè·¯å¾„>
```

### step3_build_assets.py

æ ¸å¿ƒèµ„äº§ç”Ÿæˆè„šæœ¬ï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
1. ä½¿ç”¨ Sapien ç”Ÿæˆæœºå™¨äººç‚¹äº‘
2. åŠ è½½è®­ç»ƒå¥½çš„ 3DGS æ¨¡å‹
3. è¿è¡Œ RANSAC + ICP è‡ªåŠ¨å¯¹é½
4. å°†åœºæ™¯å˜æ¢åˆ°æœºå™¨äººåæ ‡ç³»
5. ä¿å­˜å¯¹é½åçš„èµ„äº§

**å…³é”®ç‰¹æ€§**:
- æ”¯æŒä» JSON æ–‡ä»¶è¯»å–å…³èŠ‚é…ç½®
- è‡ªåŠ¨åæ ‡ç³»ç»Ÿä¸€ï¼ˆURDF åŸºåº§åæ ‡ç³»ï¼‰
- ç›´æ¥é€‚ç”¨äº Warp ç‰©ç†ä»¿çœŸ

## ğŸ¯ æŠ€æœ¯æ¶æ„

### ç»Ÿä¸€å·¥å…·é“¾

- **åºŸå¼ƒ**: `yourdfpy` åŸºç¡€çš„ç®€æ˜“å¯¹é½ï¼ˆ`calibration/robot_aligner.py`ï¼‰
- **é‡‡ç”¨**: Sapien åŸºç¡€çš„æœºå™¨äººå¤„ç†ï¼ˆ`utils/robot/robot_pc_sampler.py`ï¼‰
- **ä¼˜åŠ¿**: 
  - åæ ‡ç³»ç»Ÿä¸€ï¼Œæ¶ˆé™¤è§£æå·®å¼‚
  - ä¸ Warp ä»¿çœŸå®Œç¾å…¼å®¹
  - é²æ£’çš„å¯¹é½ç®—æ³•ï¼ˆRANSAC + ICPï¼‰

### ä¾èµ–è¯´æ˜

**æ ¸å¿ƒä¾èµ–**:
- `sapien>=3.0.0`: ç‰©ç†ä»¿çœŸå¼•æ“
- `open3d>=0.17.0`: ç‚¹äº‘å¤„ç†
- `kornia>=0.7.0`: è®¡ç®—æœºè§†è§‰åº“
- `torch>=2.5.1`: æ·±åº¦å­¦ä¹ æ¡†æ¶

**å¯é€‰ä¾èµ–**:
- `nerfstudio>=1.0.0`: 3DGS è®­ç»ƒï¼ˆæ¨èï¼‰
- `gsplat>=1.0.0`: 3DGS æ¸²æŸ“

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **Step 1 å¤±è´¥**: æ£€æŸ¥ MASt3R æ¨¡å‹æƒé‡è·¯å¾„å’Œ GPU å†…å­˜
2. **Step 2 å¤±è´¥**: ç¡®ä¿ Nerfstudio å·²å®‰è£…ï¼Œæ£€æŸ¥æ•°æ®æ ¼å¼
3. **Step 3 å¤±è´¥**: 
   - ç¡®ä¿ Sapien å·²æ­£ç¡®å®‰è£…: `pip install sapien`
   - æ£€æŸ¥ URDF è·¯å¾„å’Œ JSON é…ç½®
   - éªŒè¯å…³èŠ‚æ•°é‡åŒ¹é…

### è°ƒè¯•å»ºè®®

- æ¯ä¸ªæ­¥éª¤éƒ½ä¼šè¾“å‡ºè¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯
- å¯ä»¥å•ç‹¬è¿è¡Œä»»ä½•æ­¥éª¤è¿›è¡Œè°ƒè¯•
- ä½¿ç”¨ `tools/vis_scene_inspector.py` å¯è§†åŒ–ä¸­é—´ç»“æœ
- 3DGS è®­ç»ƒéœ€è¦å¼ºå¤§çš„ GPU å’Œè¶³å¤Ÿæ˜¾å­˜

### æ€§èƒ½ä¼˜åŒ–

- æ‰€æœ‰æ­¥éª¤éƒ½éœ€è¦ GPU (MASt3R, SAM2, 3DGS)
- 3DGS è®­ç»ƒè€—æ—¶é•¿ï¼Œå¯å‡å°‘è¿­ä»£æ¬¡æ•°è¿›è¡Œå¿«é€Ÿæµ‹è¯•
- ICP å¯¹é½å¯¹ç‚¹äº‘å¯†åº¦æ•æ„Ÿï¼Œå¯é€‚å½“é™é‡‡æ ·åŠ é€Ÿ

## ğŸ“š æ›´å¤šä¿¡æ¯

- **å·¥ä½œæµç¨‹æ–‡æ¡£**: æŸ¥çœ‹ `tools/README_WORKFLOW.md` äº†è§£è¯¦ç»†æµç¨‹
- **å®Œæ•´å·¥ä½œæµ**: æŸ¥çœ‹ `tools/WORKFLOW_COMPLETE.md` äº†è§£å®Œæ•´ç¤ºä¾‹

## ğŸ“ è®¸å¯è¯

MIT License

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

---

**æ³¨æ„**: æœ¬é¡¹ç›®é‡‡ç”¨åŸºäº Sapien çš„ç»Ÿä¸€å·¥å…·é“¾ï¼Œç¡®ä¿ä¸ Warp ç‰©ç†ä»¿çœŸçš„å®Œç¾å…¼å®¹ã€‚æ—§çš„ `yourdfpy` åŸºç¡€ä»£ç å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨æ–°çš„å·¥å…·é“¾ã€‚